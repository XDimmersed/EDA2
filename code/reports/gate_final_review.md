# `gate.cpp` (`gate_final` 版本) 逻辑缺陷排查

## 半格裁剪仍未生成正确交点
- `clip_axis_aligned_halfgrid` 在奇数 `coord2` 时直接跳过交点写入，注释里假设 “S-H 会在端点处理” （L95-L118）。
- 实际上一条横/竖边跨越半格切线后既不会追加交点、也不会保留线上的端点（`curr_cut2 < coord2` 排除了等于切线的点，L75-L77），最终切片缺边或顶点数 < 3，导致贯穿 AA 仍返回原多边形。
- 同一函数还忽略了 `curr_other/next_other` 计算结果（L71-L73）——整段逻辑并没有真正按 Sutherland–Hodgman 插值交点，说明“半格支持”只停留在注释层面。

## 贯穿判据仍只看 bbox
- `is_full_penetration` 先取 `poly.bb` 与 `aa.bb` 的交集，再仅凭交集是否覆盖 AA 两条对边来判定贯穿（L24-L51）。
- 该判据忽略了真实的多边形形状：只要 bbox 满足条件就认为贯穿，哪怕实际 Poly 只是沿边擦过；相反，若贯穿区只在 AA 中部接触上下边界而 bbox 未完全覆盖，也会被漏判。
- 这与题目要求的“Poly 必须真正在 AA 内形成一条通道”不符，会继续造成“该切不切/不该切乱切”的情况。

## 切片未做几何规范化
- 竖/横切后直接把 `clip_axis_aligned_halfgrid` 的返回顶点塞进新 `Poly`，只更新了 `v/bb/lid`（L402-L455）。
- 没有调用解析阶段用的 `ensure_ccw` 纠正顶点方向，也没有重建 `H/V` 边集；后续 `poly_intersect_manhattan` 在判入口/跨层时仍依赖 `H/V`（参见现有实现），因此这些片段在导通和 BFS 时会被误判为“不相交”。

## 导通图仍假设“片段=单个网格矩形”
- `execute_cut` 继续尝试用 `[X[i],X[i+1]]×[Y[j],Y[j+1]]` 网格来匹配每个切片 bbox，并据此建立 `cell2piece`（L464-L499）。
- 只要切出来的形状不是完美矩形（例如 L 形、半格台阶），就会落入 `unmapped_count++`，后续高电平切线检查因为找不到 `cell2piece` 而完全缺失导通边（L520-L581）。
- 这正是 L1 层远少于标准答案的根源：绝大多数片段被切出来却无法互连，AA 内 BFS 只能拿到零散残片。

## 其它明显问题
- `execute_cut` 里保留了大量 `std::cerr` 调试输出（L501-L586），实际评测会污染标准输出。

综上，`gate_final` 版本依旧未解决第三问的核心矛盾：半格切割没有建立正确轮廓，贯穿判据与导通重建仍基于 bbox 假设，导致高电平 Gate 既无法准确识别也无法在 AA 内连通。要满足赛题要求，必须按题面描述重构裁剪、规范化与邻接构建流程。
